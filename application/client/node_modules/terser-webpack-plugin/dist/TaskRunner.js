<<<<<<< HEAD
"use strict";
=======
'use strict';
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec

Object.defineProperty(exports, "__esModule", {
  value: true
});
<<<<<<< HEAD
exports.default = void 0;

var _os = _interopRequireDefault(require("os"));

var _cacache = _interopRequireDefault(require("cacache"));

var _findCacheDir = _interopRequireDefault(require("find-cache-dir"));

var _workerFarm = _interopRequireDefault(require("worker-farm"));

var _serializeJavascript = _interopRequireDefault(require("serialize-javascript"));

var _minify = _interopRequireDefault(require("./minify"));
=======

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _cacache = require('cacache');

var _cacache2 = _interopRequireDefault(_cacache);

var _findCacheDir = require('find-cache-dir');

var _findCacheDir2 = _interopRequireDefault(_findCacheDir);

var _workerFarm = require('worker-farm');

var _workerFarm2 = _interopRequireDefault(_workerFarm);

var _serializeJavascript = require('serialize-javascript');

var _serializeJavascript2 = _interopRequireDefault(_serializeJavascript);

var _minify = require('./minify');

var _minify2 = _interopRequireDefault(_minify);
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const worker = require.resolve('./worker');

class TaskRunner {
  constructor(options = {}) {
<<<<<<< HEAD
    const {
      cache,
      parallel
    } = options;
    this.cacheDir = cache === true ? (0, _findCacheDir.default)({
      name: 'terser-webpack-plugin'
    }) : cache; // In some cases cpus() returns undefined
    // https://github.com/nodejs/node/issues/19022

    const cpus = _os.default.cpus() || {
      length: 1
    };
=======
    const { cache, parallel } = options;
    this.cacheDir = cache === true ? (0, _findCacheDir2.default)({ name: 'terser-webpack-plugin' }) : cache;
    // In some cases cpus() returns undefined
    // https://github.com/nodejs/node/issues/19022
    const cpus = _os2.default.cpus() || { length: 1 };
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec
    this.maxConcurrentWorkers = parallel === true ? cpus.length - 1 : Math.min(Number(parallel) || 0, cpus.length - 1);
  }

  run(tasks, callback) {
    /* istanbul ignore if */
    if (!tasks.length) {
      callback(null, []);
      return;
    }

    if (this.maxConcurrentWorkers > 1) {
      const workerOptions = process.platform === 'win32' ? {
        maxConcurrentWorkers: this.maxConcurrentWorkers,
        maxConcurrentCallsPerWorker: 1
<<<<<<< HEAD
      } : {
        maxConcurrentWorkers: this.maxConcurrentWorkers
      };
      this.workers = (0, _workerFarm.default)(workerOptions, worker);

      this.boundWorkers = (options, cb) => {
        try {
          this.workers((0, _serializeJavascript.default)(options), cb);
        } catch (error) {
          // worker-farm can fail with ENOMEM or something else
          cb(error);
        }
      };
    } else {
      this.boundWorkers = (options, cb) => {
        try {
          cb(null, (0, _minify.default)(options));
=======
      } : { maxConcurrentWorkers: this.maxConcurrentWorkers };
      this.workers = (0, _workerFarm2.default)(workerOptions, worker);
      this.boundWorkers = (options, cb) => this.workers((0, _serializeJavascript2.default)(options), cb);
    } else {
      this.boundWorkers = (options, cb) => {
        try {
          cb(null, (0, _minify2.default)(options));
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec
        } catch (error) {
          cb(error);
        }
      };
    }

    let toRun = tasks.length;
    const results = [];
<<<<<<< HEAD

=======
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec
    const step = (index, data) => {
      toRun -= 1;
      results[index] = data;

      if (!toRun) {
        callback(null, results);
      }
    };

    tasks.forEach((task, index) => {
      const enqueue = () => {
        this.boundWorkers(task, (error, data) => {
<<<<<<< HEAD
          const result = error ? {
            error
          } : data;

          const done = () => step(index, result);

          if (this.cacheDir && !result.error) {
            _cacache.default.put(this.cacheDir, (0, _serializeJavascript.default)(task.cacheKeys), JSON.stringify(data)).then(done, done);
=======
          const result = error ? { error } : data;
          const done = () => step(index, result);

          if (this.cacheDir && !result.error) {
            _cacache2.default.put(this.cacheDir, (0, _serializeJavascript2.default)(task.cacheKeys), JSON.stringify(data)).then(done, done);
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec
          } else {
            done();
          }
        });
      };

      if (this.cacheDir) {
<<<<<<< HEAD
        _cacache.default.get(this.cacheDir, (0, _serializeJavascript.default)(task.cacheKeys)).then(({
          data
        }) => step(index, JSON.parse(data)), enqueue);
=======
        _cacache2.default.get(this.cacheDir, (0, _serializeJavascript2.default)(task.cacheKeys)).then(({ data }) => step(index, JSON.parse(data)), enqueue);
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec
      } else {
        enqueue();
      }
    });
  }

  exit() {
    if (this.workers) {
<<<<<<< HEAD
      _workerFarm.default.end(this.workers);
    }
  }

}

=======
      _workerFarm2.default.end(this.workers);
    }
  }
}
>>>>>>> de11bada15ff40c934c5f26ed44f7dbf2bb3ceec
exports.default = TaskRunner;